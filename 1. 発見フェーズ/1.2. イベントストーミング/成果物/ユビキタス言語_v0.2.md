# ユビキタス言語 v0.2

## 日付
2025-11-04

## 更新履歴
- v0.1: 初版（キックオフ・ドメイン理解フェーズ）
- v0.2: イベントストーミングで発見された用語を追加（イベントストーミングフェーズ）

## 目的
Signup Workflowプロジェクトにおいて、ドメインエキスパート（運営者）と開発者が共通して使用する言語を定義します。

---

## 用語集

### オンボーディング関連

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **オンボーディング** | Onboarding | サインアップの全工程（3つの工程すべて）を指す | プラン選択、サインアップ、決済情報登録の3工程を含む |
| **オンボード中** | Onboarding | オンボーディング未完了の状態 | 一部の工程のみ完了している状態 |
| **工程** | Step / Phase | オンボーディングの各ステップ | 3つの工程: プラン選択、サインアップ、決済情報登録 |
| **工程完了状態** | Step Completion Status | 各工程が完了しているかどうかの状態 | MySQLに永続化される。完了/未完了で管理 |
| **工程管理** | Step Management | 各ユーザーの工程完了状態を記録・管理する仕組み | Temporalと連携して実装 |

### ユーザー状態

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **未登録ユーザー** | Unregistered User | まだ認証情報を登録していないユーザー | プラン選択中または選択前の状態 |
| **見込み客** | Prospect | プラン選択〜サインアップ前のユーザー | 未登録ユーザーと同義 |
| **オンボード中ユーザー** | Onboarding User | 認証情報は登録済みだが、オンボーディング未完了のユーザー | サインイン可能だが、決済情報が未登録 |
| **アクティブユーザー** | Active User | 全工程完了済みのユーザー | サービス利用可能な状態 |

### プランとサービス

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **プラン** | Plan | サービスレベル（料金プラン）のこと | サブスクリプションの種類を指す |
| **プラン選択** | Plan Selection | ユーザーがサービスレベルを選ぶ行為 | オンボーディングの第1工程 |
| **プラン一覧画面** | Plan List Screen | ユーザーがプランを選択するための画面 | リードモデル（参照情報） |

### 認証関連

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **サインアップ** | Sign Up | 認証情報の登録 | メールアドレス・パスワードの登録。オンボーディングの第2工程 |
| **認証情報** | Credentials | ユーザーを識別するための情報 | 現在はメールアドレスとパスワード |
| **サインイン** | Sign In | 登録済みユーザーのログイン | 認証情報を使った認証処理 |
| **サインアップフォーム** | Sign Up Form | 認証情報を入力する画面 | リードモデル（参照情報） |
| **サインインフォーム** | Sign In Form | サインインする際の入力画面 | リードモデル（参照情報） |

### 決済関連

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **決済情報** | Payment Information | クレジットカード情報・請求先情報 | Stripeで収集・管理される |
| **決済情報登録** | Payment Registration | 決済情報を登録する工程 | オンボーディングの第3工程 |
| **決済情報登録フォーム** | Payment Registration Form | 決済情報を入力する画面 | リードモデル（参照情報） |
| **決済完了** | Payment Completed | Stripeで初回課金が成功した状態 | Webhook通知で確認 |
| **決済失敗** | Payment Failed | クレジットカードが拒否された等の理由で決済が失敗した状態 | 再試行が必要 |
| **決済完了Webhook** | Payment Completed Webhook | Stripeから決済完了を通知するHTTPリクエスト | 決済完了イベントのトリガー |

### ユーザー行動

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **離脱** | Drop-off / Abandonment | ユーザーがオンボーディング途中でブラウザを閉じる等、プロセスを中断すること | 特に「サインアップ後、決済情報登録前」が問題 |
| **再開** | Resume | 離脱したユーザーが再度サイトにアクセスし、続きから工程を進めること | 今回実装する主要機能 |
| **再試行** | Retry | 決済失敗後に、再度決済情報を登録すること | - |

### 工程チェックと遷移（イベントストーミングで発見）

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **工程チェック** | Step Check | ユーザーの工程完了状態を確認する処理 | あらゆる画面アクセス時に実行される |
| **工程状態をチェックする** | Check Step Status | 工程チェックを実行するコマンド | システムが自動実行 |
| **未完了工程検出** | Incomplete Step Detection | ユーザーがまだ完了していない工程を見つけること | 工程チェックの結果の1つ |
| **工程飛ばし検出** | Step Skipping Detection | ユーザーが不正に工程を飛ばそうとしたことを検出 | 例: 直接URLで決済画面にアクセス |
| **全工程完了検出** | All Steps Completed Detection | すべての工程が完了していることを確認 | オンボーディング完了の条件 |
| **未完了工程への遷移** | Transition to Incomplete Step | チェック結果に基づき、未完了の工程へ自動的にリダイレクトすること | システムが自動実行 |
| **適切な工程への遷移** | Transition to Appropriate Step | 工程飛ばしを検出した場合、正しい工程へリダイレクトすること | システムが自動実行 |
| **次に実行すべき工程** | Next Step to Execute | ユーザーが次に完了すべき工程 | 工程チェックの結果として決定される |
| **次の工程が案内された** | Next Step Guided | ユーザーに次の工程が提示されたイベント | 画面遷移後に発生 |

### システム概念

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **自動遷移** | Automatic Transition | サインイン時に、オンボーディング状態に応じて適切な画面へ自動的にリダイレクトすること | 未完了工程への誘導 |
| **リードモデル** | Read Model | ユーザーやシステムが判断材料として参照する情報 | 画面、フォーム、データ等 |
| **コマンド** | Command | ユーザーやシステムが実行する命令・アクション | 命令形で表現（〜する） |
| **ドメインイベント** | Domain Event | システム内で発生した重要な出来事 | 過去形で表現（〜された） |
| **ポリシー** | Policy / Business Rule | イベントが発生した結果、自動的に別のコマンドを実行するビジネスルール | 「もしAならばB」の形式 |
| **アクター** | Actor | コマンドを実行する主体 | ユーザー、システム、外部システム等 |

### Temporal関連（イベントストーミングで明確化）

| 用語 | 英語 | 定義 | 補足 |
|------|------|------|------|
| **Temporal** | Temporal | ワークフローエンジン | 今回のプロジェクトで使用 |
| **ワークフロー** | Workflow | 一連の処理の流れ | Temporalで管理される |
| **ワークフロー状態** | Workflow State | ワークフローの現在の状態 | 「決済情報登録待ち」等 |
| **状態の永続化** | State Persistence | ワークフロー状態を永続的に記憶し続けること | Temporalの主要な役割 |

---

## ドメインイベント一覧（イベントストーミングで特定）

| ドメインイベント | 英語 | 発生タイミング | トリガーとなるコマンド |
|-----------------|------|---------------|---------------------|
| **プラン選択完了** | Plan Selected | サインアップフォームへ遷移時 | プランを選択する |
| **ユーザー登録完了** | User Registered | ユーザー情報がDB保存された時点 | 認証情報を登録する |
| **サインイン成功** | Sign In Succeeded | 認証が成功した時点 | サインインする |
| **決済完了** | Payment Completed | Stripe決済完了Webhook受信時 | 決済完了Webhookを送信する |
| **決済失敗** | Payment Failed | Stripe決済失敗時 | 決済完了Webhookを送信する |
| **未完了工程検出** | Incomplete Step Detected | 工程チェックで未完了が判明した時 | 工程状態をチェックする |
| **工程飛ばし検出** | Step Skipping Detected | 工程チェックで飛ばしが判明した時 | 工程状態をチェックする |
| **全工程完了検出** | All Steps Completed Detected | 工程チェックで全完了が判明した時 | 工程状態をチェックする |
| **次の工程が案内された** | Next Step Guided | 未完了工程への遷移後 | 未完了工程へ遷移する |
| **オンボーディング完了** | Onboarding Completed | 全工程完了後 | オンボーディングを完了する |

---

## コマンド一覧（イベントストーミングで特定）

### ユーザーが実行するコマンド

| コマンド | 英語 | アクター | 参照する情報（リードモデル） | 結果（ドメインイベント） |
|---------|------|---------|---------------------------|------------------------|
| **プランを選択する** | Select Plan | ユーザー（見込み客） | プラン一覧画面 | プラン選択完了 |
| **認証情報を登録する** | Register Credentials | ユーザー（見込み客） | サインアップフォーム | ユーザー登録完了 |
| **サインインする** | Sign In | ユーザー（オンボード中 or アクティブ） | サインインフォーム | サインイン成功 |
| **決済情報を登録する** | Register Payment Information | ユーザー（オンボード中） | 決済情報登録フォーム | → Stripeへ送信 |

### システムが実行するコマンド

| コマンド | 英語 | アクター | 参照する情報（リードモデル） | 結果（ドメインイベント） |
|---------|------|---------|---------------------------|------------------------|
| **工程状態をチェックする** | Check Step Status | システム | ユーザーの工程完了状態（MySQL） | 未完了工程検出 / 工程飛ばし検出 / 全工程完了検出 |
| **未完了工程へ遷移する** | Transition to Incomplete Step | システム | 次に実行すべき工程の情報 | 次の工程が案内された |
| **適切な工程へ遷移する** | Transition to Appropriate Step | システム | 次に実行すべき工程の情報 | 次の工程が案内された |
| **サービストップ画面へ遷移する** | Transition to Service Top | システム | - | - |
| **オンボーディングを完了する** | Complete Onboarding | システム | - | オンボーディング完了 |
| **サインアップフォームを表示する** | Show Sign Up Form | システム | - | - |
| **決済情報登録フォームを表示する** | Show Payment Form | システム | - | - |

### 外部システムが実行するコマンド

| コマンド | 英語 | アクター | 結果（ドメインイベント） |
|---------|------|---------|------------------------|
| **決済完了Webhookを送信する** | Send Payment Completed Webhook | Stripe | 決済完了 / 決済失敗 |

---

## ポリシー（ビジネスルール）一覧（イベントストーミングで特定）

| ポリシー名 | トリガー（イベント） | 実行されるコマンド | 説明 |
|-----------|-------------------|------------------|------|
| **サインアップフォームへ遷移するルール** | プラン選択完了 | サインアップフォームを表示する | プラン選択後、自動的にサインアップフォームへ遷移 |
| **決済情報登録へ遷移するルール** | ユーザー登録完了 | 決済情報登録フォームを表示する | サインアップ後、自動的に決済フォームへ遷移 |
| **工程チェックルール** | サインイン成功 / 画面アクセス | 工程状態をチェックする | あらゆる画面アクセス時に必ず実行される |
| **未完了工程への誘導ルール** | 未完了工程検出 | 未完了工程へ遷移する | オンボード中ユーザーを適切な工程へ誘導 |
| **工程飛ばし検出ルール** | 工程飛ばし検出 | 適切な工程へ遷移する | 不正な工程アクセスを防ぐ |
| **全工程完了ユーザーの誘導ルール** | サインイン成功 + 全工程完了 | サービストップ画面へ遷移する | アクティブユーザーをサービスへ誘導 |
| **全工程完了確認ルール** | 決済完了 | 工程状態をチェックする → オンボーディング完了 | 決済完了後、全工程完了を確認してオンボーディングを完了 |
| **決済再試行ルール** | 決済失敗 | 決済情報登録フォームを表示する | 決済失敗時、再度フォームを表示 |

---

## 工程の定義

### 第1工程: プラン選択

| 項目 | 内容 |
|------|------|
| **工程名** | プラン選択 |
| **ユーザーアクション** | プランをクリックして選択 |
| **コマンド** | プランを選択する |
| **入力情報** | なし（ボタンクリックのみ） |
| **保存先** | Cookie（ユーザー未識別のため） |
| **完了条件** | サインアップフォームへ遷移した時点 |
| **完了イベント** | プラン選択完了 |
| **状態遷移** | 未選択 → 選択済み |

### 第2工程: サインアップ（認証情報登録）

| 項目 | 内容 |
|------|------|
| **工程名** | サインアップ（認証情報登録） |
| **ユーザーアクション** | メールアドレス・パスワードを入力して送信 |
| **コマンド** | 認証情報を登録する |
| **入力情報** | メールアドレス、パスワード |
| **保存先** | データベース（MySQL） |
| **完了条件** | ユーザー情報がDB保存された時点 |
| **完了イベント** | ユーザー登録完了 |
| **状態遷移** | 未登録 → 登録済み（オンボード中） |
| **重要な副作用** | この時点でサインイン可能なユーザーとして扱われる |

### 第3工程: 決済情報登録

| 項目 | 内容 |
|------|------|
| **工程名** | 決済情報登録 |
| **ユーザーアクション** | クレジットカード情報・請求先情報を入力して送信 |
| **コマンド** | 決済情報を登録する |
| **入力情報** | クレジットカード情報、請求先住所等 |
| **外部システム** | Stripe |
| **完了条件** | Stripeから決済完了webhookを受信した時点 |
| **完了イベント** | 決済完了 |
| **状態遷移** | 未登録 → 登録中 → 決済完了（アクティブユーザー） |
| **失敗時の状態** | 未登録 → 登録中 → 決済失敗 → 未登録（再試行） |
| **意味** | 初回課金の完了 |

---

## 境界付けられたコンテキスト（イベントストーミングで発見）

### 1. プラン選択コンテキスト

| 項目 | 内容 |
|------|------|
| **責務** | プランの選択と提示 |
| **主要な機能** | プラン一覧表示、プラン選択処理 |
| **アクター** | ユーザー（見込み客） |
| **主要なドメインイベント** | プラン選択完了 |

### 2. ユーザー登録コンテキスト（認証コンテキスト）

| 項目 | 内容 |
|------|------|
| **責務** | ユーザーの認証と識別 |
| **主要な機能** | サインアップ処理、サインイン処理、ユーザー管理 |
| **アクター** | ユーザー（見込み客/オンボード中/アクティブ） |
| **主要なドメインイベント** | ユーザー登録完了、サインイン成功 |

### 3. 決済コンテキスト

| 項目 | 内容 |
|------|------|
| **責務** | 決済処理 |
| **主要な機能** | 決済情報登録、Stripe連携、決済処理 |
| **アクター** | ユーザー（オンボード中）、Stripe |
| **主要なドメインイベント** | 決済完了、決済失敗 |
| **外部システム** | Stripe |

### 4. オンボーディング管理コンテキスト（工程管理コンテキスト）⭐ **今回の中核**

| 項目 | 内容 |
|------|------|
| **責務** | 工程の完了状態管理と適切な画面への誘導 |
| **主要な機能** | 工程状態管理、工程チェック、画面遷移制御、Temporal連携 |
| **アクター** | システム |
| **主要なドメインイベント** | 未完了工程検出、工程飛ばし検出、全工程完了検出、オンボーディング完了 |
| **重要な技術** | Temporal（状態の永続化） |
| **データストア** | MySQL（工程完了状態） |

---

## 状態遷移の概要

```
未登録ユーザー（見込み客）
  ↓ プラン選択
プラン選択済み（Cookie保存）
  ↓ 認証情報登録
オンボード中ユーザー（DB保存、サインイン可能）
  ↓ 決済情報登録
決済処理中
  ↓ Stripe決済完了webhook
アクティブユーザー（サービス利用可能）
```

---

## Temporalの役割（イベントストーミングで明確化）

| 項目 | 内容 |
|------|------|
| **主要な責務** | ワークフローが「決済情報登録待ち」という状態で一時停止していることを、ワーカーの再起動やサーバーの障害に関係なく、永続的に記憶し続ること |
| **対象** | オンボーディング管理コンテキスト（工程管理コンテキスト） |
| **管理する状態** | 各ユーザーの工程完了状態 |
| **重要なポイント** | Temporalが直接コマンドを実行するわけではない。状態の永続化が主な役割 |

---

## 今後の更新について

このユビキタス言語は、プロジェクトの進行に伴って更新されます。
- モデリングフェーズで新しい概念が発見された場合
- ドメインエキスパートとの議論で用語の定義が変更された場合
- 実装中に用語の曖昧さが発見された場合

バージョン管理:
- v0.1: 初版（キックオフ・ドメイン理解フェーズ）
- v0.2: イベントストーミングで発見された用語を追加（イベントストーミングフェーズ）
- 今後、重要な変更があった場合はバージョンを更新
