@startuml 業務フロー図

title Signup Workflow - オンボーディング業務フロー (BPMN風)

|#LightBlue|ユーザー|
start

:プランを選択;
note right
  **用語**: プラン = サービスレベル（料金プラン）
  **保存方法**: Cookie（ユーザー未識別のため）
  **完了条件**: サインアップフォームへ遷移時
end note

|#LightGreen|システム|
:プラン選択完了イベント;
:サインアップフォームへ遷移;

|ユーザー|
:認証情報を登録\n(メールアドレス・パスワード);

|システム|
:ユーザー登録完了イベント\n(DB保存);
note right
  **重要**: この時点でサインイン可能な
  ユーザーとして扱われる
  **状態**: オンボード中
end note

|ユーザー|
:決済情報を登録\n(Stripe経由);

|システム|
:決済処理実行;

if (決済成功?) then (yes)
  :Stripe決済完了webhook受信;
  :オンボーディング完了;
  note right
    **状態**: アクティブユーザー
    **用語**: オンボーディング = サインアップの全工程
  end note

  |ユーザー|
  :サービス利用開始;
  stop

else (no)
  :決済失敗イベント;
  |ユーザー|
  :決済情報登録画面へ再遷移;
  note right
    カード拒否時は再入力を促す
  end note
  detach
endif

@enduml

@startuml 業務フロー図_離脱と再開シナリオ

title Signup Workflow - 離脱と再開シナリオ（To-Be: 理想の状態）

|#LightBlue|ユーザー|
start

:プランを選択;

|#LightGreen|システム|
:プラン選択完了;

|ユーザー|
if (このタイミングで離脱?) then (yes)
  #Pink:ブラウザを閉じる\n（プラン選択後、サインアップ前）;

  |システム|
  note right
    **シナリオA**: Cookie以外に情報なし
  end note

  |ユーザー|
  :再度サイトにアクセス;

  |システム|
  :最初からプラン選択画面へ遷移;
  stop

else (no)
  :認証情報を登録;

  |システム|
  :ユーザー登録完了\n（状態: オンボード中）;

  |ユーザー|
  if (このタイミングで離脱?) then (yes)
    #Pink:ブラウザを閉じる\n（サインアップ後、決済情報登録前）;

    |システム|
    note right
      **シナリオB**: 最も問題となるケース
      ユーザー情報はDBに存在
      状態: オンボード中
    end note

    |ユーザー|
    :再度サイトにアクセス;

    if (サインアップボタンを押す?) then (yes)
      |システム|
      :既に登録済みを検出;
      :「既にアカウントがあります。\nサインインしてください」と案内;

      |ユーザー|
      :サインインボタンを押す;
    else (no)
      :サインインボタンを押す;
    endif

    |システム|
    :認証処理;
    :オンボーディング状態をチェック;
    :未完了工程を判定\n（決済情報が未登録）;
    :決済情報登録画面へ自動遷移;
    note right
      **重要**: Temporalで工程管理
      次に実行すべき工程へ自動誘導
    end note

    |ユーザー|
    :決済情報を登録;

  else (no)
    :決済情報を登録;
  endif

  |システム|
  :決済処理実行;

  if (決済成功?) then (yes)
    :Stripe決済完了webhook受信;
    :オンボーディング完了\n（状態: アクティブユーザー）;

    |ユーザー|
    :サービス利用開始;
    stop

  else (no)
    :決済失敗;
    :決済情報登録画面へ再遷移;
    detach
  endif
endif

@enduml
